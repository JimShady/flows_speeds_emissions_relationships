head(grid_traffic)
emissions_grids              <- merge(emissions, grid, by.x = 'grid_exactcut_id', by.y = 'grid_exact_cut')
rm(emissions)
emissions_grids              <- emissions_grids[order(emissions_grids$toid),]
all_data                <- merge(emissions_grids, grid_traffic, by.x = c('toid', 'easting', 'northing'), by.y = c('toid', 'easting', 'northing'))
rm(grid, grid_traffic, emissions_grids,drop)
head(all_data)
ukgrid = "+init=epsg:27700"
one_km_emissions <- aggregate(data = all_data, total_emissions ~ pollutant + easting + northing, FUN=sum)
sources          <- as.character((unique(one_km_emissions$pollutant)))
for (i in 1:length(sources)) {
temp              <- one_km_emissions[one_km_emissions$pollutant == sources[i],]
coordinates(temp) <- ~ easting + northing
temp$pollutant    <- NULL
gridded(temp)     <- TRUE
proj4string(temp) <- CRS(ukgrid)
temp              <- raster(temp)
names(temp)       <- tolower(sources[i])
if (i == 1) { one_km_emissions_raster <- temp} else {one_km_emissions_raster <- stack(one_km_emissions_raster, temp)}
}
ten_km_emissions_raster  <- aggregate(one_km_emissions_raster, fact = 10, fun=sum)
rm(one_km_emissions, one_km_emissions_raster, temp, i)
ten_km_emissions_polygons <- rasterToPolygons(ten_km_emissions_raster)
coordinates(all_data)           <- ~ easting + northing
proj4string(all_data)           <- CRS(ukgrid)
result                                                  <- point.in.poly(all_data, ten_km_emissions_polygons)
result                                                  <- data.frame(result)
result$ten_km_contribution                              <- NA
result[result$pollutant == 'no2',]$ten_km_contribution    <- result[result$pollutant == 'no2',]$total_emissions    / result[result$pollutant == 'no2',]$no2
result[result$pollutant == 'nox',]$ten_km_contribution    <- result[result$pollutant == 'nox',]$total_emissions    / result[result$pollutant == 'nox',]$nox
result[result$pollutant == 'pm10',]$ten_km_contribution   <- result[result$pollutant == 'pm10',]$total_emissions   / result[result$pollutant == 'pm10',]$pm10
result[result$pollutant == 'pm25',]$ten_km_contribution   <- result[result$pollutant == 'pm25',]$total_emissions   / result[result$pollutant == 'pm25',]$pm25
rm(all_data)
result <- result[result$total_emissions > 0,]
head(result)
rm(test)
test <- merge(aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + dpollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + pollutant, mean),
by = c('dotref', 'pollutant'))
test <- merge(aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + pollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + pollutant, mean),
by = c('dotref', 'pollutant'))
result <- merge(aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + desc_term + pollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + desc_term + pollutant, mean),
by = c('dotref', 'pollutant'))
head(result)
head(result,50)
training_index <- sample(nrow(result), round(nrow(result) * 0.8,0))
training_data <- result[training_index,]
testing_data <- result[-training_index,]
model_results <- data.frame(pollutant = NA,
intercept = as.numeric(''),
length_coef = as.numeric(''),
speed_coef = as.numeric(''),
total_light_coef = as.numeric(''),
total_heavy_coef = as.numeric(''),
stringsAsFactors = F)
model_results_list <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy,
data=training_data[training_data$pollutant == sources[i],])
model_results_list[[i]] <- model
model_results[i,] <- c(sources[i], as.numeric(coef(model)[1]), as.numeric(coef(model)[2]), as.numeric(coef(model)[3]), as.numeric(coef(model)[4]), as.numeric(coef(model)[5]))
rm(model)
}
model_results$intercept         <- as.numeric(model_results$intercept)
model_results$length_coef       <- as.numeric(model_results$length_coef)
model_results$speed_coef        <- as.numeric(model_results$speed_coef)
model_results$total_light_coef  <- as.numeric(model_results$total_light_coef)
model_results$total_heavy_coef  <- as.numeric(model_results$total_heavy_coef)
model_results
summary(model_results_list[[1]])$adj.r.squared
summary(model_results_list[[2]])$adj.r.squared
summary(model_results_list[[3]])$adj.r.squared
summary(model_results_list[[4]])$adj.r.squared
testing_data$prediction <- NA
for (i in 1:length(sources)) {
testing_data[testing_data$pollutant == sources[i],'prediction'] <-    model_results[model_results$pollutant == sources[i],]$intercept+(
(testing_data[testing_data$pollutant == sources[i],]$length      * model_results[model_results$pollutant == sources[i],]$length_coef) +
(testing_data[testing_data$pollutant == sources[i],]$speed       * model_results[model_results$pollutant == sources[i],]$speed_coef) +
(testing_data[testing_data$pollutant == sources[i],]$total_light * model_results[model_results$pollutant == sources[i],]$total_light_coef) +
(testing_data[testing_data$pollutant == sources[i],]$total_heavy * model_results[model_results$pollutant == sources[i],]$total_heavy_coef))
}
head(testing_data)
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point() +
facet_wrap(.~pollutant, scales = 'free', ncol = 1)
library(plotly)
install.packages("plotly")
library(plotly)
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point() +
facet_wrap(.~pollutant, scales = 'free', ncol = 1)
plot <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point() +
facet_wrap(.~pollutant, scales = 'free', ncol = 1)
ggplotly(plot)
plot <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point() +
facet_wrap(.~pollutant, scales = 'free', ncol = 2)
ggplotly(plot)
head(testing_Data)
head(testing_data)
no2 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5)
nox <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5)
pm10 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5)
pm25 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5)
ggplotly(pm25)
no2 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5) +
theme(legend.position="bottom")
nox <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5) +
theme(legend.position="bottom")
pm10 <- ggplot(testing_data, aes +
theme(legend.position="bottom")(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5)
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1, alpha=0.5) +
theme(legend.position="bottom")
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=2, alpha=0.5) +
theme(legend.position="bottom")
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=2, alpha=0.5) +
theme(legend.position="bottom")
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = 'none')
ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
head(training_data)
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
### Loading any missing libraries
library(rvest)
library(stringr)
library(raster)
library(rgdal)
library(rgeos)
library(ggplot2)
library(sf)
library(rmarkdown)
library(rasterVis)
library(knitr)
library(kableExtra)
library(reshape2)
library(mapview)
require(spatialEco)
require(sp)
library(plotly)
grid        <- read.csv('X:/Projects/LAEI2013_TfL_Strategy/z_GridsForJames.csv')
grid        <- grid[,c('GridIdEx', 'Easting', 'Northing')]
names(grid) <- c('grid_exact_cut', 'easting', 'northing')
kable(head(grid)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
traffic_flows                 <- read.csv('X:/Projects/LAEI2013_Gdrive/TrafficFlows/Major_WithAdjustedIbus_AADT/z_AADT_ExactCut_WithIbus_2013.csv')
names(traffic_flows)          <- tolower(names(traffic_flows))
drop                          <- c('year', 'location_exactcut', 'boroughname_exactcut', 'tlrn', 'irr', 'motorwaynumber', 'petrolcar', 'dieselcar', 'electriccar', 'petrollgv', 'diesellgv', 'electriclgv', 'ltbus', 'coach')
traffic_flows                 <- traffic_flows[, !(names(traffic_flows) %in% drop)]
traffic_flows$toid            <- as.character(traffic_flows$toid)
traffic_flows$total_vehicles  <- (traffic_flows$motorcycle + traffic_flows$taxi + traffic_flows$car + traffic_flows$busandcoach + traffic_flows$lgv + traffic_flows$rigid2axle + traffic_flows$rigid3axle + traffic_flows$rigid4axle +     traffic_flows$artic3axle + traffic_flows$artic5axle + traffic_flows$artic6axle)
traffic_flows$total_light     <- (traffic_flows$motorcycle + traffic_flows$taxi + traffic_flows$car)
traffic_flows$total_heavy     <- (traffic_flows$busandcoach + traffic_flows$lgv + traffic_flows$rigid2axle + traffic_flows$rigid3axle + traffic_flows$rigid4axle + traffic_flows$artic3axle + traffic_flows$artic5axle + traffic_flows$artic6axle)
drop                          <- c('motorcycle', 'taxi', 'car', 'busandcoach', 'lgv', 'rigid2axle', 'rigid3axle', 'rigid4axle', 'artic3axle', 'artic5axle', 'artic6axle')
traffic_flows                 <- traffic_flows[, !(names(traffic_flows) %in% drop)]
kable(head(traffic_flows)) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
road_info                    <- read.csv('erg_roads_info.csv')
names(road_info)             <- tolower(names(road_info))
road_info                    <- road_info[,c('toid', 'desc_term')]
road_info$toid               <- as.character(road_info$toid)
emissions                     <- read.csv('X:/Projects/LAEI2013_TfL_Strategy/FilesForHerald4/EmissionsByLink/INPUT_RESULTS_LAEI_ExactCutIntersect_Major_2013_LAEI_V117.csv')
names(emissions)              <- tolower(names(emissions))
drop                          <- c('emissions', 'year', 'petrolcar', 'dieselcar', 'petrollgv', 'diesellgv', 'ltbus', 'coach', 'electriccar', 'electriclgv')
emissions                     <- emissions[, !(names(emissions) %in% drop)]
emissions$total_emissions     <- emissions$motorcycle + emissions$taxi + emissions$car + emissions$busandcoach + emissions$lgv + emissions$rigid + emissions$artic + emissions$rigid2axle + emissions$rigid3axle + emissions$rigid4axle + emissions$artic3axle + emissions$artic5axle + emissions$artic6axle
emissions$toid                <- as.character(emissions$toid)
drop                          <- c('motorcycle', 'taxi', 'car', 'busandcoach', 'lgv', 'rigid', 'artic', 'rigid2axle', 'rigid3axle', 'rigid4axle', 'artic3axle', 'artic5axle', 'artic6axle')
emissions                     <- emissions[, !(names(emissions) %in% drop)]
emissions                     <- emissions[!(emissions$pollutant %in% c('TB_PM10_SW', 'TB_PM25_SW')),]
emissions$pollutant           <- as.character(emissions$pollutant)
emissions[grep('pm25', tolower(emissions$pollutant)),'pollutant'] <- 'pm25'
emissions[grep('pm10', tolower(emissions$pollutant)),'pollutant'] <- 'pm10'
emissions$gridid            <- as.character(emissions$gridid)
emissions$grid_exactcut_id  <- as.character(emissions$grid_exactcut_id)
emissions$dotref            <- as.character(emissions$dotref)
emissions$pollutant         <- tolower(emissions$pollutant)
emissions <- aggregate(total_emissions ~ gridid + toid + grid_exactcut_id + dotref + length + pollutant, data=emissions, FUN=sum)
kable(head(emissions)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
traffic_flows             <- merge(traffic_flows, road_info, by.x = 'toid', by.y = 'toid')
rm(road_info)
grid_traffic              <- merge(traffic_flows, grid, by.x = c('grid_exactcut_id'), by.y = c('grid_exact_cut'))
rm(traffic_flows)
grid_traffic              <- grid_traffic[order(grid_traffic$toid),]
kable(head(grid_traffic)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
grid_traffic <- aggregate(data = grid_traffic, FUN=mean, cbind(speed, total_vehicles, total_light, total_heavy)~ easting+northing+toid+desc_term)
kable(head(grid_traffic[order(grid_traffic$toid),])) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
emissions_grids              <- merge(emissions, grid, by.x = 'grid_exactcut_id', by.y = 'grid_exact_cut')
rm(emissions)
emissions_grids              <- emissions_grids[order(emissions_grids$toid),]
all_data                <- merge(emissions_grids, grid_traffic, by.x = c('toid', 'easting', 'northing'), by.y = c('toid', 'easting', 'northing'))
rm(grid, grid_traffic, emissions_grids,drop)
kable(all_data[all_data$easting == 512500 & all_data$northing == 198500 & all_data$pollutant == 'no2',]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
ukgrid = "+init=epsg:27700"
one_km_emissions <- aggregate(data = all_data, total_emissions ~ pollutant + easting + northing, FUN=sum)
sources          <- as.character((unique(one_km_emissions$pollutant)))
for (i in 1:length(sources)) {
temp              <- one_km_emissions[one_km_emissions$pollutant == sources[i],]
coordinates(temp) <- ~ easting + northing
temp$pollutant    <- NULL
gridded(temp)     <- TRUE
proj4string(temp) <- CRS(ukgrid)
temp              <- raster(temp)
names(temp)       <- tolower(sources[i])
if (i == 1) { one_km_emissions_raster <- temp} else {one_km_emissions_raster <- stack(one_km_emissions_raster, temp)}
}
plot(one_km_emissions_raster$no2)
ten_km_emissions_raster  <- aggregate(one_km_emissions_raster, fact = 10, fun=sum)
rm(one_km_emissions, one_km_emissions_raster, temp, i)
plot(ten_km_emissions_raster$no2)
ten_km_emissions_polygons <- rasterToPolygons(ten_km_emissions_raster)
mapview(ten_km_emissions_polygons, map.types = 'OpenStreetMap')
coordinates(all_data)           <- ~ easting + northing
proj4string(all_data)           <- CRS(ukgrid)
result                                                  <- point.in.poly(all_data, ten_km_emissions_polygons)
result                                                  <- data.frame(result)
result$ten_km_contribution                              <- NA
result[result$pollutant == 'no2',]$ten_km_contribution    <- result[result$pollutant == 'no2',]$total_emissions    / result[result$pollutant == 'no2',]$no2
result[result$pollutant == 'nox',]$ten_km_contribution    <- result[result$pollutant == 'nox',]$total_emissions    / result[result$pollutant == 'nox',]$nox
result[result$pollutant == 'pm10',]$ten_km_contribution   <- result[result$pollutant == 'pm10',]$total_emissions   / result[result$pollutant == 'pm10',]$pm10
result[result$pollutant == 'pm25',]$ten_km_contribution   <- result[result$pollutant == 'pm25',]$total_emissions   / result[result$pollutant == 'pm25',]$pm25
rm(all_data)
result <- result[result$total_emissions > 0,]
result <- merge(aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + desc_term + pollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + desc_term + pollutant, mean),
by = c('dotref', 'pollutant'))
training_index <- sample(nrow(result), round(nrow(result) * 0.8,0))
training_data <- result[training_index,]
testing_data <- result[-training_index,]
head(training_Data)
head(training_data)
names(result)
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
### Loading any missing libraries
library(rvest)
library(stringr)
library(raster)
library(rgdal)
library(rgeos)
library(ggplot2)
library(sf)
library(rmarkdown)
library(rasterVis)
library(knitr)
library(kableExtra)
library(reshape2)
library(mapview)
require(spatialEco)
require(sp)
library(plotly)
grid        <- read.csv('X:/Projects/LAEI2013_TfL_Strategy/z_GridsForJames.csv')
grid        <- grid[,c('GridIdEx', 'Easting', 'Northing')]
names(grid) <- c('grid_exact_cut', 'easting', 'northing')
kable(head(grid)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
traffic_flows                 <- read.csv('X:/Projects/LAEI2013_Gdrive/TrafficFlows/Major_WithAdjustedIbus_AADT/z_AADT_ExactCut_WithIbus_2013.csv')
names(traffic_flows)          <- tolower(names(traffic_flows))
drop                          <- c('year', 'location_exactcut', 'boroughname_exactcut', 'tlrn', 'irr', 'motorwaynumber', 'petrolcar', 'dieselcar', 'electriccar', 'petrollgv', 'diesellgv', 'electriclgv', 'ltbus', 'coach')
traffic_flows                 <- traffic_flows[, !(names(traffic_flows) %in% drop)]
traffic_flows$toid            <- as.character(traffic_flows$toid)
traffic_flows$total_vehicles  <- (traffic_flows$motorcycle + traffic_flows$taxi + traffic_flows$car + traffic_flows$busandcoach + traffic_flows$lgv + traffic_flows$rigid2axle + traffic_flows$rigid3axle + traffic_flows$rigid4axle +     traffic_flows$artic3axle + traffic_flows$artic5axle + traffic_flows$artic6axle)
traffic_flows$total_light     <- (traffic_flows$motorcycle + traffic_flows$taxi + traffic_flows$car)
traffic_flows$total_heavy     <- (traffic_flows$busandcoach + traffic_flows$lgv + traffic_flows$rigid2axle + traffic_flows$rigid3axle + traffic_flows$rigid4axle + traffic_flows$artic3axle + traffic_flows$artic5axle + traffic_flows$artic6axle)
drop                          <- c('motorcycle', 'taxi', 'car', 'busandcoach', 'lgv', 'rigid2axle', 'rigid3axle', 'rigid4axle', 'artic3axle', 'artic5axle', 'artic6axle')
traffic_flows                 <- traffic_flows[, !(names(traffic_flows) %in% drop)]
kable(head(traffic_flows)) %>%  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
road_info                    <- read.csv('erg_roads_info.csv')
names(road_info)             <- tolower(names(road_info))
road_info                    <- road_info[,c('toid', 'desc_term')]
road_info$toid               <- as.character(road_info$toid)
emissions                     <- read.csv('X:/Projects/LAEI2013_TfL_Strategy/FilesForHerald4/EmissionsByLink/INPUT_RESULTS_LAEI_ExactCutIntersect_Major_2013_LAEI_V117.csv')
names(emissions)              <- tolower(names(emissions))
drop                          <- c('emissions', 'year', 'petrolcar', 'dieselcar', 'petrollgv', 'diesellgv', 'ltbus', 'coach', 'electriccar', 'electriclgv')
emissions                     <- emissions[, !(names(emissions) %in% drop)]
emissions$total_emissions     <- emissions$motorcycle + emissions$taxi + emissions$car + emissions$busandcoach + emissions$lgv + emissions$rigid + emissions$artic + emissions$rigid2axle + emissions$rigid3axle + emissions$rigid4axle + emissions$artic3axle + emissions$artic5axle + emissions$artic6axle
emissions$toid                <- as.character(emissions$toid)
drop                          <- c('motorcycle', 'taxi', 'car', 'busandcoach', 'lgv', 'rigid', 'artic', 'rigid2axle', 'rigid3axle', 'rigid4axle', 'artic3axle', 'artic5axle', 'artic6axle')
emissions                     <- emissions[, !(names(emissions) %in% drop)]
emissions                     <- emissions[!(emissions$pollutant %in% c('TB_PM10_SW', 'TB_PM25_SW')),]
emissions$pollutant           <- as.character(emissions$pollutant)
emissions[grep('pm25', tolower(emissions$pollutant)),'pollutant'] <- 'pm25'
emissions[grep('pm10', tolower(emissions$pollutant)),'pollutant'] <- 'pm10'
emissions$gridid            <- as.character(emissions$gridid)
emissions$grid_exactcut_id  <- as.character(emissions$grid_exactcut_id)
emissions$dotref            <- as.character(emissions$dotref)
emissions$pollutant         <- tolower(emissions$pollutant)
emissions <- aggregate(total_emissions ~ gridid + toid + grid_exactcut_id + dotref + length + pollutant, data=emissions, FUN=sum)
kable(head(emissions)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
traffic_flows             <- merge(traffic_flows, road_info, by.x = 'toid', by.y = 'toid')
rm(road_info)
grid_traffic              <- merge(traffic_flows, grid, by.x = c('grid_exactcut_id'), by.y = c('grid_exact_cut'))
rm(traffic_flows)
grid_traffic              <- grid_traffic[order(grid_traffic$toid),]
kable(head(grid_traffic)) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
grid_traffic <- aggregate(data = grid_traffic, FUN=mean, cbind(speed, total_vehicles, total_light, total_heavy)~ easting+northing+toid+desc_term)
kable(head(grid_traffic[order(grid_traffic$toid),])) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
emissions_grids              <- merge(emissions, grid, by.x = 'grid_exactcut_id', by.y = 'grid_exact_cut')
rm(emissions)
emissions_grids              <- emissions_grids[order(emissions_grids$toid),]
all_data                <- merge(emissions_grids, grid_traffic, by.x = c('toid', 'easting', 'northing'), by.y = c('toid', 'easting', 'northing'))
rm(grid, grid_traffic, emissions_grids,drop)
kable(all_data[all_data$easting == 512500 & all_data$northing == 198500 & all_data$pollutant == 'no2',]) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = F, position = "left")
ukgrid = "+init=epsg:27700"
one_km_emissions <- aggregate(data = all_data, total_emissions ~ pollutant + easting + northing, FUN=sum)
sources          <- as.character((unique(one_km_emissions$pollutant)))
for (i in 1:length(sources)) {
temp              <- one_km_emissions[one_km_emissions$pollutant == sources[i],]
coordinates(temp) <- ~ easting + northing
temp$pollutant    <- NULL
gridded(temp)     <- TRUE
proj4string(temp) <- CRS(ukgrid)
temp              <- raster(temp)
names(temp)       <- tolower(sources[i])
if (i == 1) { one_km_emissions_raster <- temp} else {one_km_emissions_raster <- stack(one_km_emissions_raster, temp)}
}
plot(one_km_emissions_raster$no2)
ten_km_emissions_raster  <- aggregate(one_km_emissions_raster, fact = 10, fun=sum)
rm(one_km_emissions, one_km_emissions_raster, temp, i)
plot(ten_km_emissions_raster$no2)
ten_km_emissions_polygons <- rasterToPolygons(ten_km_emissions_raster)
mapview(ten_km_emissions_polygons, map.types = 'OpenStreetMap')
coordinates(all_data)           <- ~ easting + northing
proj4string(all_data)           <- CRS(ukgrid)
result                                                  <- point.in.poly(all_data, ten_km_emissions_polygons)
result                                                  <- data.frame(result)
result$ten_km_contribution                              <- NA
result[result$pollutant == 'no2',]$ten_km_contribution    <- result[result$pollutant == 'no2',]$total_emissions    / result[result$pollutant == 'no2',]$no2
result[result$pollutant == 'nox',]$ten_km_contribution    <- result[result$pollutant == 'nox',]$total_emissions    / result[result$pollutant == 'nox',]$nox
result[result$pollutant == 'pm10',]$ten_km_contribution   <- result[result$pollutant == 'pm10',]$total_emissions   / result[result$pollutant == 'pm10',]$pm10
result[result$pollutant == 'pm25',]$ten_km_contribution   <- result[result$pollutant == 'pm25',]$total_emissions   / result[result$pollutant == 'pm25',]$pm25
rm(all_data)
result <- result[result$total_emissions > 0,]
head(result)
nrow( aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + desc_term + pollutant, sum))
nrow( aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + desc_term + pollutant, mean))
nrow(merge(
aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + desc_term + pollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + desc_term + pollutant, mean),
by = c('dotref', 'pollutant', 'desc_term')))
result <- merge(
aggregate(data = result, cbind(length, total_emissions, ten_km_contribution) ~ dotref + desc_term + pollutant, sum),
aggregate(data = result, cbind(speed, total_vehicles, total_light, total_heavy) ~ dotref + desc_term + pollutant, mean),
by = c('dotref', 'pollutant', 'desc_term'))
training_index <- sample(nrow(result), round(nrow(result) * 0.8,0))
training_data <- result[training_index,]
testing_data <- result[-training_index,]
head(training_Data)
head(training_data)
model_results <- data.frame(pollutant = NA,
intercept = as.numeric(''),
length_coef = as.numeric(''),
speed_coef = as.numeric(''),
total_light_coef = as.numeric(''),
total_heavy_coef = as.numeric(''),
desc_term        = as.character(''),
stringsAsFactors = F)
model_results_list <- list()
model_results <- data.frame(pollutant = NA,
intercept = as.numeric(''),
length_coef = as.numeric(''),
speed_coef = as.numeric(''),
total_light_coef = as.numeric(''),
total_heavy_coef = as.numeric(''),
desc_term        = as.character(''),
stringsAsFactors = F)
model_results_list <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term,
data=training_data[training_data$pollutant == sources[i],])
model_results_list[[i]] <- model
model_results[i,] <- c(sources[i], as.numeric(coef(model)[1]), as.numeric(coef(model)[2]), as.numeric(coef(model)[3]), as.numeric(coef(model)[4]), as.numeric(coef(model)[5]),                            as.numeric(coef(model)[6]))
rm(model)
}
model_results$intercept         <- as.numeric(model_results$intercept)
model_results$length_coef       <- as.numeric(model_results$length_coef)
model_results$speed_coef        <- as.numeric(model_results$speed_coef)
model_results$total_light_coef  <- as.numeric(model_results$total_light_coef)
model_results$total_heavy_coef  <- as.numeric(model_results$total_heavy_coef)
summary(model_results_list[[1]])$adj.r.squared
summary(model_results_list[[2]])$adj.r.squared
summary(model_results_list[[3]])$adj.r.squared
summary(model_results_list[[4]])$adj.r.squared
model_results
summary(model_results_list[[1]])
head(training_data)
class(training_data$desc_term)
head(training_data)
predict(testing_data, model_results_list[[1]])
predict(model_results_list[[1]], testing_data)
models <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term,
data=training_data[training_data$pollutant == sources[i],])
models[[i]] <- model
rm(model)
}
models
names(models)
models[[1]]
models[[1]]$coefficients
predict(models[[1]],testing_data)
predict(models[[1]],testing_data[1:10,])
head(training_data)
temp <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term + pollutant,
data=training_data)
summary(temp)
summary(model[[1]])$adj.r.squared
models <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term,
data=training_data[training_data$pollutant == sources[i],])
models[[i]] <- model
rm(model)
}
summary(model[[1]])$adj.r.squared
summary(models[[1]])$adj.r.squared
summary(models[[2]])$adj.r.squared
summary(models[[3]])$adj.r.squared
summary(models[[4]])$adj.r.squared
models[[1]]
testing_data[testing_data$pollutant == sources[i],]
testing_data$prediction <- NA
for (i in 1:length(sources)) {
testing_data[testing_data$pollutant == sources[i],'prediction'] <-   predict(models[[i]], testing_data[testing_data$pollutant == sources[i],])
}
training_index <- sample(nrow(result), round(nrow(result) * 0.8,0))
training_data <- result[training_index,]
testing_data <- result[-training_index,]
models <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term,
data=training_data[training_data$pollutant == sources[i],])
models[[i]] <- model
rm(model)
}
testing_data$prediction <- NA
for (i in 1:length(sources)) {
testing_data[testing_data$pollutant == sources[i],'prediction'] <-   predict(models[[i]], testing_data[testing_data$pollutant == sources[i],])
}
table(result$desc_term)
result[result$desc_term %in% c('Alley', 'Private Road - Publicly Accessible', 'Pedestrianised Street'),]
result[!(result$desc_term %in% c('Alley', 'Private Road - Publicly Accessible', 'Pedestrianised Street')),]
result <- result[!(result$desc_term %in% c('Alley', 'Private Road - Publicly Accessible', 'Pedestrianised Street')),]
training_index <- sample(nrow(result), round(nrow(result) * 0.8,0))
training_data <- result[training_index,]
testing_data <- result[-training_index,]
models <- list()
for (i in 1:length(sources)) {
model <- lm(ten_km_contribution ~ length + speed + total_light + total_heavy + desc_term,
data=training_data[training_data$pollutant == sources[i],])
models[[i]] <- model
rm(model)
}
testing_data$prediction <- NA
for (i in 1:length(sources)) {
testing_data[testing_data$pollutant == sources[i],'prediction'] <-   predict(models[[i]], testing_data[testing_data$pollutant == sources[i],])
}
testing_data
no2 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
nox <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
pm10 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
pm25 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term.x)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
ggplotly(no2)
head(testing_data)
no2 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
nox <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
pm10 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
pm25 <- ggplot(testing_data, aes(ten_km_contribution, prediction, colour=desc_term)) +
geom_point(size=1.5, alpha=0.5) +
theme(legend.position="bottom",
legend.title = element_blank())
ggplotly(no2)
ggplotly(nox)
ggplotly(pm10)
ggplotly(pm25)
